---
title: "heart_failure"
author: "Rob Meulenkamp"
date: '2022-09-14'
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(pander)
library(kableExtra)
library(scales)
library(reshape2)
library(factoextra)
library(dplyr)
library(tidyr)
library(naniar)
library(tibble)
library(ggpubr)
library(pROC)
```

# EDA logbook

## Introduction
Cardiovascular diseases (CVD) is one of the most common death globally. This makes up for 31% of all deaths worldwide. Heart disease is provoked by atherosclerosis. This means the buildup of plaques or fatty deposits in the walls of the coronary arteries in several years.  
The coronary arteries enclose the outside of the heart and provide blood oxygen and nutrients to the heart muscle. If the plaque builds up in the arteries, there is fewer space for blood to flow naturally and deliver oxygen to the heart. This possibly cause angina (chest pain) or a heart attack. Four out of five CVD deaths are result of heart attacks and strokes. One-third of these deaths appear in people under the age of 70.

This data set include 11 features that are viable to use for predicting a heart disease.


Data:
https://www.kaggle.com/datasets/fedesoriano/heart-failure-prediction?resource=download


## Research question

Is it feasible to produce an accurate machine learning algorithm that predicts the possibility of developing a heart disease in a wide array of patients? 

## Read the data

```{r load in data}

heartdata <- read.csv("data/heart.csv")

```

## Parsing data
Parsing data to change the type of variables. If someone is diagnosed it's either 0 or 1. This can be confusing sometimes. It's easier to keep track with True and False values. 
```{r Cleaning}

heartdata$HeartDisease <- as.logical(heartdata$HeartDisease)
heartdata$FastingBS <- as.logical(heartdata$FastingBS)



# Changes Y/N to Boolean
heartdata$ExerciseAngina <- heartdata$ExerciseAngina == "Y"


# Function split column into new column and make it True or False
# For example if the patient has the condition yes or no
# x = value in column you want to split
# y = column the value belongs to
# dataframe = dataframe the desired value is stored 
# Returns the desired column
splitColumn <- function(x, y, dataframe){
  dataframe[,x] <- NA 
  dataframe[,x][which(dataframe[,y] == x)] <- x
  dataframe[,x][is.na(dataframe[,x])] <- FALSE
  dataframe[,x][dataframe[,x] == x] <- TRUE
  return(dataframe[,x])
  
}

value_targets <- c("ATA", "ASY", "NAP", "TA")

for (column in value_targets){
    new_column <- splitColumn(column, "ChestPainType", heartdata)
    frame <- as.data.frame(as.logical(new_column))
    colnames(frame) <- column
    heartdata <- add_column(heartdata, frame)

}

heartdata$ChestPainType <- NULL


```
Splitting the different conditions is done for ChestPainType otherwise the column can't be used for making Principal component analysis.


\pagebreak

## Codebook
The data set doesn't include a codebook with annotated header or columns. The codebook consist of the column name, full name, and the type of the data. This codebook is handmade. 
```{r Codebook}

codebook <- read.csv("data/codebook.csv")
pander(codebook, style = "rmarkdown", caption ="Overview created codebook")

```
Most of the attributes are categorical instead of numerical data.
Extra information about every attribute can be found in the following link. 
(Attribute information)[https://www.kaggle.com/datasets/fedesoriano/heart-failure-prediction?resource=download]

\pagebreak
The most important is that values are read correctly and has to be examined. 
```{r}

str(heartdata)

```
fortunately it looks like every column have been read correctly. 





\pagebreak
Inspecting the different columns if they contain Na's.This is done to get a better understanding about the data set. 
```{r Missing values}
colSums(is.na(heartdata))
```
The data set don't have missing values. Now it's time to inspect the data with a summary.

## Summary

```{r Summary}
summ <- summary(heartdata[c("Age", "RestingBP", "Cholesterol", "MaxHR", "Oldpeak")])
tab <- sub('.*:', '', summ)
rownames(tab) <- c("Min", "1st. Qu", "Median", "Mean", "3rd. Qu", "Max")
kable(tab, caption = "5 num of numerical valies") %>% 
  kable_styling(latex_options="scale_down")
```
The first thing that stands out is the 0 value as minimum value in the column RestingBP. If a person has a resting blood pressure of 0 it means that the person is dead. Column cholesterol has 0 values too as minimum value. A person has mostly of the time cholesterol level higher than 0. This needs to be investigate carefully when the data is cleaned before using the machine learning algorithm.    

\newpage

## Visualisations 
### Histogram Age vs Heart disease
```{r fig.cap="Histogram of age against frequency for HD", fig.align="center"}
ggplot(heartdata, aes(Age, fill=HeartDisease)) +
  geom_histogram(bins=10) +
  ylab("Frequency") +
  ggtitle("Frequency heart disease for age")
```

In the graph above, there is possibly a correlation between age and heart disease.
When the age increases the frequency of heart diseases do as well. 
This needs more investigation.

\newpage
### Age linked to heartdisease
```{r Age related to heartdisease, fig.cap="Percentage of patients impacted by HD", fig.align="center"}
ggplot(heartdata) + 
  geom_smooth(aes(Age, HeartDisease * 100), method="loess", formula = "y ~ x", color=hue_pal()(1)) + 
  ylab("Heart Disease (%)") + 
  xlab("Age (years)") +
  ggtitle("Percentage of patients affected by heart disease") + 
  ylim(c(0, 100)) +
  xlim(c(25, 80))

```
With Smooth line it is possible to see that the percentage of patients increases with age and heart disease. The only thing is that after the age of 65 there is starting a decline.  
The reason for the decline is perhaps death for the people above 65 who have a heart disease.

For people above the age of 65 are more likely to develop a heart disease which can cause heart attacks, strokes or heart failures. This is potentially the cause of the decline. 
Source: [Heart Health and Aging](https://www.nia.nih.gov/health/heart-health-and-aging)


\newpage
### Ratio between males and females

```{r Ratio male - female, fig.cap="Ratio Male - Female", fig.align="center"}
ggplot(heartdata) +
  geom_bar(aes(Sex, fill=HeartDisease)) +
  labs(title="Man vs Women having heartdisease") +
  ylab("frequency")

```
The barplot shows the ratio between male and female. The ratio is more skewed towards males.
The most noticeable is that males have a higher proportion to have heartdisease in comparison with the females. For the female, it is more likely to not have a heartdisease. 



### Chest pain against heart disease 

```{r Different chest pain types against heart disease, fig.cap="proportions between chest pain with or without heart disease", fig.align="center"}

ggplot(heartdata) +
  geom_bar(aes(ChestPainType, fill=HeartDisease)) + ggtitle("Chestpaintype vs heart disease")   + 
  ylab("Frequency")
  

```

In the barplot above, Asymptomatic pain (ASY) is the most frequent chest pain type for people with heart disease.


\newpage
### Effect of chest pain type against the resting blood pressure
```{r density plot, fig.align="center", fig.cap="Density plot Resting blood pressue against chest pain"}
ggplot(heartdata, aes(x=RestingBP, group=ChestPainType, colour=ChestPainType)) + 
  geom_density()
```
The pain type doesn't seem to have an effect on the blood pressure of the individual. 


### influence of Electrocardiogram (ECG) against heart disease

ECG type:

| Code | Explanation |
|---|---|
| Normal | Normal | 
| ST | Having ST-T wave abnormality (T wave inversions and/or ST elevation or depression of > 0.05 mV). | 
| LVH | Showing probable or definite left ventricular hypertrophy by Estes' criteria. |



Electrocardiogram (ECG or EKG) is a straightforward test that records and detects your heart's electrical activity. An ECG shows how fast your heart is beating and shows if your rhythm of your heartbeats is steady or irregular. But also indicates the strength and timing of the electical impulses passing through each part of your hart. 
Source: [Electrocardiogram](https://www.nhlbi.nih.gov/health/heart-tests)


\newpage
```{r Electrocardiogram, fig.align="center" fig.cap="Frequency different ECG types against heart disease"}

ggplot(heartdata) +
  geom_bar(aes(RestingECG, fill=HeartDisease)) + ggtitle("resting electrocardiogram vs heart disease")   + 
  ylab("Frequency")



freq_RestingECG <- table(heartdata$RestingECG)

```

The frequency for a normal (`r freq_RestingECG[2]`) electrical activity is exceptionally high in comparison with ST (`r freq_RestingECG[3]`)  and  LVH (`r freq_RestingECG[1]`). The ratio between people with heart disease and without heart disease are almost even with a normal electrical activity. The restingECG column probably won't be the deciding factor in predicting people with heart disease. This needs more investigation with principal component analysis in order to determine the value of the restingECG column and other columns as well. 




\newpage
### Comparison between MaxHR against age grouped by sex
```{r MaxHR against age , fig.align="center", fig.cap="Maximum heart rate against age and grouped by sex"}
ggplot(heartdata, aes(Age, MaxHR, group=Sex, colour = Sex)) + 
  geom_point(alpha=0.10) + geom_smooth(se=F) + ggtitle("Comparison between MaxHR and age grouped by sex")

count_table <- heartdata %>% group_by(Sex) %>% 
      filter(Age > 55) %>%
      count(Sex)
```
In the graph above goes MaxHR down when people become older. Only the line goes up again after the age of 55 for females. This is possible because of the lack of data for females after the age of 55. Females contain `r count_table[[2]][1]` amount of data and for males this is `r count_table[[2]][2]` data points. 
The ratio is not balanced. To analyse this a density plot is made for the difference in datapoints per sex.  





\newpage
### Density of age grouped by sex
```{r density plot sex, fig.align="center", fig.cap="Amount of datapoints per age grouped by sex"}
ggplot(heartdata) + 
  geom_density(aes(Age, colour=Sex, fill=Sex), alpha=0.05) + 
  ggtitle("Density plot comparing sexes")
```
The above graph shows that there is not much difference in age comparing male and female.





\newpage
### Principal component analysis
```{r Principal component analysis, fig.align="center" fig.cap="PCA variable plot"}


heartdataPca <- heartdata[, c(1,4,5,6,8, 9, 13:16)]
res.pca <- prcomp(heartdataPca, scale = TRUE)


fviz_pca_var(res.pca,
             col.var = "cos2", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE 
             )


# Contributions of variables to PC1
fviz_contrib(res.pca, choice = "var", axes = 1, top = 10)

# Contributions of variables to PC2
fviz_contrib(res.pca, choice = "var", axes = 2, top = 10)
```
In the circle diagram and in the contribution diagram the asymptomatic pain and non-Anginal pain has the biggest contribution for a positive or negative diagnosing the heart disease. One downside is that it's hard to predict for patients who don't have visible symptoms. Two other important contributors are MaxHR and Age. These two variables are important because it could be measured for every patient thus are viable. Last, the column ExerciseAngina has an important contribution. If it's possible to diagnose the patient with exercise angina this column becomes vital for predicting people with heart disease.  



### Cleaning
Cholesterol 0-values are replaced with the median of the cholesterol column due to missing measurements.
Median is less sensitive to outliers in comparison with the mean. 
```{r}

heartdata$Cholesterol[heartdata$Cholesterol == 0] <- NA


# replace NA's with the median for every column
for(i in 1:ncol(heartdata)){
  heartdata[is.na(heartdata[,i]), i] <- median(heartdata[,i], na.rm = TRUE)
}

heartdata <- heartdata %>% relocate(HeartDisease, .after = last_col())
write.csv(heartdata, "data/clean_heart.csv", row.names = FALSE)

```




